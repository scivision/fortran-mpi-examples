name: windows-cmake

on:
  push:
    paths:
      - "**.f90"
      - "**.F90"
      - "**.cmake"
      - "**/CMakeLists.txt"
      - ".github/workflows/windows-cmake.yml"


jobs:

  windows:
    runs-on: windows-latest
    name: CMake build on Windows
    timeout-minutes: 15

    steps:
    - uses: msys2/setup-msys2@v2
      id: msys2
      with:
        update: true
        install: >-
          mingw-w64-ucrt-x86_64-gcc
          mingw-w64-ucrt-x86_64-gcc-fortran
          mingw-w64-ucrt-x86_64-msmpi

    - name: Put MSYS2_MinGW64 on PATH
      run: echo "${{ steps.msys2.outputs.msys2-location }}/ucrt64/bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Setup Microsoft MPI
      uses: mpi4py/setup-mpi@v1
      with:
        mpi: msmpi

    - &checkout
      uses: actions/checkout@v6

    - run: cmake --workflow debug

    - run: cmake --workflow release


  wsl:
    runs-on: windows-latest
    timeout-minutes: 10

    defaults:
      run:
        shell: wsl-bash {0}

    steps:

    - uses: Vampire/setup-wsl@v6
      with:
        distribution: Ubuntu-24.04
        additional-packages:
          cmake ninja-build gcc g++ gfortran libopenmpi-dev
        use-cache: true
        wsl-shell-user: tester

    - name: tell OS release
      run: cat /etc/os-release

    - name: tell WSL version
      run: wsl.exe -l -v
      shell: pwsh

    - *checkout

# -B /tmp/build to have write perms in WSL

    - name: CMake Configure
      run: cmake -B/tmp/build -G Ninja

    - name: CMake Build
      run: cmake --build /tmp/build

    - name: CMake Test
      run: ctest --test-dir /tmp/build -V

# seems there's not yet an Vampire/setup-wsl@v6 option to set environment variables
